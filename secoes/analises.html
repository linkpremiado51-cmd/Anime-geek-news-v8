<div class="destaque-wrapper">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">

    <div id="container-principal">
        <div style="padding: 100px; text-align: center; opacity: 0.5; color: var(--text-main);">
            <i class="fa-solid fa-circle-notch fa-spin"></i> Sincronizando com a Cloud...
        </div>
    </div>
    
    <div id="pagination-control" style="text-align: center; padding: 30px; display: none;">
        <button id="btn-carregar-mais" class="btn-paginacao-geek">
            <i class="fa-solid fa-chevron-down"></i> Carregar mais conteúdos
        </button>
    </div>

    <div id="toast-copiado">Link copiado para a área de transferência!</div>

    <div id="modal-noticia" class="modal-noticia-overlay">
        <div id="modal-conteudo">
            <button id="modal-fechar" onclick="window.fecharModal()">×</button>
            <div id="modal-header-layout">
                <div id="modal-titulo" class="destaque-titulo"></div>
                <div id="modal-categoria" class="destaque-categoria"></div>
            </div>
            <iframe id="modal-video" allowfullscreen></iframe>
            <p id="modal-resumo" class="destaque-resumo"></p>
            <a id="modal-link" target="_blank" class="btn-ver-artigo">
                <i class="fa-solid fa-book-open"></i> Ler artigo completo
            </a>
            <div id="modal-ficha" class="destaque-info-grid"></div>
        </div>
    </div>

    <div id="modal-comentarios-geek" class="modal-geek-overlay">
        <div class="modal-geek-content">
            <div class="modal-geek-header">
                <div class="header-main-title"><i class="fa-solid fa-comments"></i> Discussão Geek</div>
                <button onclick="window.fecharComentarios()" class="btn-geek-close">×</button>
            </div>
            <div class="modal-geek-body" id="flow-comentarios">
                <div class="geek-comment-card">
                    <div class="geek-avatar" style="background: var(--primary);">A</div>
                    <div class="geek-info-col">
                        <div class="geek-user-row"><span class="g-name">AniGeek Bot</span><span class="g-time">Agora</span></div>
                        <div class="geek-text">Seja o primeiro a comentar sobre esta atualização!</div>
                    </div>
                </div>
            </div>
            <div class="modal-geek-footer">
                <div class="input-wrapper-geek">
                    <input type="text" placeholder="Escreva sua opinião..." id="input-comentario-real">
                    <button class="btn-send-geek"><i class="fa-solid fa-paper-plane"></i></button>
                </div>
            </div>
        </div>
    </div>

    <style>
        :root {
            --primary: #e63946;
            --bg-card: #ffffff;
            --text-main: #1a1a1a;
            --border: #eeeeee;
        }

        /* Container de Destaque */
        .destaque-secao {
            background: var(--bg-card);
            border-radius: 16px;
            margin-bottom: 40px;
            overflow: hidden;
            border: 1px solid var(--border);
            transition: transform 0.3s ease;
        }

        .destaque-padding { padding: 25px; }
        .destaque-titulo { font-size: 28px; font-weight: 900; line-height: 1.2; margin-bottom: 10px; color: var(--text-main); }
        .destaque-categoria { font-size: 12px; font-weight: 800; text-transform: uppercase; color: var(--tema-cor); margin-bottom: 10px; }
        .destaque-resumo { font-size: 15px; line-height: 1.6; color: #555; margin-bottom: 20px; }

        /* Media Player */
        .destaque-media iframe { width: 100%; aspect-ratio: 16/9; border: none; background: #000; display: block; }

        /* Grid de Informações */
        .destaque-info-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 15px; margin: 20px 0; background: #f9f9f9; padding: 15px; border-radius: 12px; }
        .info-item { display: flex; flex-direction: column; }
        .info-label { font-size: 10px; text-transform: uppercase; font-weight: 800; opacity: 0.6; }
        .info-valor { font-size: 13px; font-weight: 700; color: #333; }

        /* Botão de Artigo */
        .btn-ver-artigo { display: inline-flex; align-items: center; gap: 8px; padding: 12px 24px; background: var(--text-main); color: white; border-radius: 30px; text-decoration: none; font-weight: 700; font-size: 14px; margin-bottom: 10px; }

        /* Carrossel de Vídeos (Troca Instantânea) */
        .carrossel-temas { padding: 20px; background: #fafafa; border-top: 1px solid var(--border); }
        .temas-label { font-size: 13px; font-weight: 800; text-transform: uppercase; display: block; margin-bottom: 15px; }
        .temas-container { display: flex; gap: 15px; overflow-x: auto; padding-bottom: 10px; scroll-behavior: smooth; }
        .tema-card { min-width: 160px; position: relative; cursor: pointer; border-radius: 10px; overflow: hidden; }
        .tema-thumb { width: 100%; aspect-ratio: 16/9; object-fit: cover; transition: 0.3s; }
        .tema-titulo { font-size: 11px; font-weight: 700; padding: 8px 0; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; line-height: 1.3; }
        .play-overlay { position: absolute; top: 35%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.7); color: white; width: 34px; height: 34px; border-radius: 50%; display: flex; align-items: center; justify-content: center; opacity: 0; transition: 0.3s; pointer-events: none; }
        .tema-card:hover .play-overlay { opacity: 1; }
        .tema-card:hover .tema-thumb { filter: brightness(0.7); }

        /* Actions Bar */
        .premium-actions-bar { display: flex; padding: 15px 20px; gap: 15px; border-top: 1px solid #eee; }
        .btn-premium-icon { background: #f0f0f0; border: none; padding: 8px 16px; border-radius: 20px; font-weight: 700; font-size: 12px; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: 0.2s; }
        .btn-premium-icon:hover { background: #e5e5e5; }

        /* Trigger Comentários */
        .comments-trigger-bar { margin: 0 20px 20px 20px; background: #f1f3f5; border-radius: 12px; padding: 12px 20px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; font-size: 13px; font-weight: 700; color: #444; }

        /* Modal Notícia Overlay */
        .modal-noticia-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 10000; overflow-y: auto; padding: 20px; }
        #modal-conteudo { background: white; max-width: 850px; margin: 40px auto; border-radius: 16px; padding: 30px; position: relative; }
        #modal-fechar { position: absolute; top: 20px; right: 20px; width: 40px; height: 40px; border-radius: 50%; border: none; background: #f0f0f0; font-size: 20px; cursor: pointer; z-index: 10; }

        /* Modal Comentários */
        .modal-geek-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); backdrop-filter: blur(4px); z-index: 10001; display: none; align-items: flex-end; justify-content: center; }
        .modal-geek-overlay.active { display: flex; }
        .modal-geek-content { background: white; width: 100%; max-width: 600px; height: 80vh; border-radius: 20px 20px 0 0; display: flex; flex-direction: column; animation: slideUp 0.3s ease; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .modal-geek-header { padding: 20px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; font-weight: 900; }
        .modal-geek-body { flex: 1; overflow-y: auto; padding: 20px; }
        .modal-geek-footer { padding: 15px; border-top: 1px solid #eee; }
        .input-wrapper-geek { display: flex; background: #f0f2f5; padding: 10px 15px; border-radius: 30px; gap: 10px; }
        .input-wrapper-geek input { flex: 1; border: none; background: transparent; outline: none; }
        
        .geek-comment-card { display: flex; gap: 12px; margin-bottom: 15px; }
        .geek-avatar { width: 35px; height: 35px; border-radius: 50%; color: white; display: flex; align-items: center; justify-content: center; font-weight: bold; flex-shrink: 0; }
        .geek-user-row { display: flex; gap: 10px; align-items: center; margin-bottom: 3px; }
        .g-name { font-weight: 800; font-size: 13px; }
        .g-time { font-size: 10px; color: #999; }
        .geek-text { font-size: 14px; color: #333; line-height: 1.4; }

        #toast-copiado { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background: #333; color: white; padding: 12px 25px; border-radius: 30px; font-size: 13px; font-weight: 700; opacity: 0; transition: 0.4s; z-index: 99999; pointer-events: none; }
        #toast-copiado.mostrar { opacity: 1; bottom: 50px; }
        
        /* Utilitários */
        .btn-paginacao-geek { background: var(--text-main); color: white; border: none; padding: 14px 35px; border-radius: 30px; font-weight: 800; cursor: pointer; transition: 0.3s; }
        .btn-paginacao-geek:hover { transform: scale(1.05); }
    </style>

    <script type="module">
        // Importação direta do Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // Configuração
        const firebaseConfig = {
            apiKey: "AIzaSyBC_ad4X9OwCHKvcG_pNQkKEl76Zw2tu6o",
            authDomain: "anigeeknews.firebaseapp.com",
            projectId: "anigeeknews",
            storageBucket: "anigeeknews.firebasestorage.app",
            messagingSenderId: "769322939926",
            appId: "1:769322939926:web:6eb91a96a3f74670882737"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Estado Local
        let state = {
            todasNoticias: [],
            exibidas: 5,
            cancelRealTime: null
        };

        // --- FUNÇÕES GLOBAIS (Expostas para o HTML) ---
        
        // Troca de Vídeo Instantânea
        window.trocarVideoInstantaneo = (playerId, videoId) => {
            const player = document.getElementById(playerId);
            if (player) {
                player.src = `https://www.youtube.com/embed/${videoId}?autoplay=1`;
                player.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        };

        window.fecharModal = () => {
            const m = document.getElementById('modal-noticia');
            if(m) {
                m.style.display = 'none';
                const f = m.querySelector('iframe');
                if(f) f.src = ""; // Para o vídeo
            }
            const url = new URL(window.location);
            url.searchParams.delete('id');
            window.history.pushState({}, '', url);
        };

        window.abrirComentarios = () => {
            document.getElementById('modal-comentarios-geek').classList.add('active');
            document.body.style.overflow = 'hidden';
        };

        window.fecharComentarios = () => {
            document.getElementById('modal-comentarios-geek').classList.remove('active');
            document.body.style.overflow = 'auto';
        };

        window.copiarLink = async (url) => {
            try {
                await navigator.clipboard.writeText(url);
                const toast = document.getElementById('toast-copiado');
                toast.classList.add('mostrar');
                setTimeout(() => toast.classList.remove('mostrar'), 2500);
            } catch (err) { console.error(err); }
        };

        window.shareNews = (titulo, url) => {
            if (navigator.share) {
                navigator.share({ title: titulo, url }).catch(() => window.copiarLink(url));
            } else {
                window.copiarLink(url);
            }
        };

        // --- RENDERIZAÇÃO ---
        window.renderizarNoticias = (dadosOverride = null) => {
            const container = document.getElementById('container-principal');
            if (!container) return;

            const lista = dadosOverride || state.todasNoticias.slice(0, state.exibidas);
            const baseUrl = window.location.origin + window.location.pathname;

            container.innerHTML = lista.map(news => {
                const shareUrl = `${baseUrl}?id=${encodeURIComponent(news.id)}`;
                const views = Math.floor(Math.random() * 500) + 50 + "K";

                return `
                <article class="destaque-secao" style="--tema-cor: ${news.cor || '#e63946'}">
                    <div class="destaque-padding">
                        <div class="destaque-categoria">${news.categoria}</div>
                        <h2 class="destaque-titulo">${news.titulo}</h2>
                        <p class="destaque-resumo">${news.resumo}</p>
                        
                        <a href="${news.linkArtigo}" target="_blank" class="btn-ver-artigo">
                            <i class="fa-solid fa-book-open"></i> LER ARTIGO COMPLETO
                        </a>

                        <div class="destaque-info-grid">
                            ${news.ficha ? news.ficha.map(f => `
                                <div class="info-item">
                                    <span class="info-label">${f.label}</span>
                                    <span class="info-valor">${f.valor}</span>
                                </div>
                            `).join('') : ''}
                        </div>
                    </div>

                    <div class="destaque-media">
                        <iframe id="player-${news.id}" src="${news.videoPrincipal?.trim()}" allowfullscreen></iframe>
                    </div>

                    <div class="premium-actions-bar">
                        <button class="btn-premium-icon" onclick="window.shareNews('${news.titulo.replace(/'/g, "\\'")}', '${shareUrl}')">
                            <i class="fa-solid fa-share-nodes"></i> Compartilhar
                        </button>
                        <button class="btn-premium-icon">
                            <i class="fa-solid fa-chart-line"></i> ${views}
                        </button>
                    </div>

                    <div class="carrossel-temas">
                        <span class="temas-label">Vídeos Relacionados</span>
                        <div class="temas-container">
                            ${news.relacionados ? news.relacionados.map(rel => `
                                <div class="tema-card" onclick="window.trocarVideoInstantaneo('player-${news.id}', '${rel.idVid}')">
                                    <img src="${rel.thumb?.trim()}" class="tema-thumb">
                                    <div class="play-overlay"><i class="fa-solid fa-play"></i></div>
                                    <div class="tema-titulo">${rel.titulo}</div>
                                </div>
                            `).join('') : ''}
                        </div>
                    </div>

                    <div class="comments-trigger-bar" onclick="window.abrirComentarios()">
                        <span><i class="fa-solid fa-message"></i> Ver comentários da comunidade</span>
                        <i class="fa-solid fa-chevron-right"></i>
                    </div>
                </article>
                `;
            }).join('');

            // Paginação
            const p = document.getElementById('pagination-control');
            if(p) p.style.display = (state.exibidas < state.todasNoticias.length) ? 'block' : 'none';
        };

        // --- MOTOR FIREBASE ---
        const startEngine = () => {
            const q = collection(db, "analises");
            state.cancelRealTime = onSnapshot(q, (snap) => {
                state.todasNoticias = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                state.todasNoticias.sort((a,b) => (b.data || 0) - (a.data || 0));
                window.renderizarNoticias();
                
                // Deep Link Check
                const id = new URLSearchParams(window.location.search).get('id');
                if(id) {
                    const n = state.todasNoticias.find(x => x.id === id);
                    if(n) {
                        const m = document.getElementById('modal-noticia');
                        document.getElementById('modal-titulo').innerText = n.titulo;
                        document.getElementById('modal-video').src = n.videoPrincipal;
                        document.getElementById('modal-resumo').innerText = n.resumo;
                        document.getElementById('modal-link').href = n.linkArtigo;
                        m.style.display = 'block';
                    }
                }
            });
        };

        // Inicialização
        startEngine();

        // Listener Paginacao
        document.getElementById('btn-carregar-mais').onclick = () => {
            state.exibidas += 5;
            window.renderizarNoticias();
        };

    </script>
</div>
